

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding an Org to a Channel &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Upgrading Your Network Components" href="upgrading_your_network_tutorial.html" />
    <link rel="prev" title="Building Your First Network" href="build_network.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="_static/images/youtube_button.png"/></a>

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatis.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">What’s new in the v2.0 Alpha</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html#release-notes">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">Key Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="developapps/developing_applications.html">Developing Applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="write_first_app.html">Writing Your First Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial/commercial_paper.html">Commercial paper tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="build_network.html">Building Your First Network</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding an Org to a Channel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-environment">Setup the Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bring-org3-into-the-channel-with-the-script">Bring Org3 into the Channel with the Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bring-org3-into-the-channel-manually">Bring Org3 into the Channel Manually</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-the-org3-crypto-material">Generate the Org3 Crypto Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prepare-the-cli-environment">Prepare the CLI Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetch-the-configuration">Fetch the Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-the-configuration-to-json-and-trim-it-down">Convert the Configuration to JSON and Trim It Down</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-the-org3-crypto-material">Add the Org3 Crypto Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sign-and-submit-the-config-update">Sign and Submit the Config Update</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-leader-election">Configuring Leader Election</a></li>
<li class="toctree-l3"><a class="reference internal" href="#join-org3-to-the-channel">Join Org3 to the Channel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-define-and-invoke-chaincode">Install, define, and invoke chaincode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="upgrading_your_network_tutorial.html">Upgrading Your Network Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="private_data_tutorial.html">Using Private Data in Fabric</a></li>
<li class="toctree-l2"><a class="reference internal" href="chaincode.html">Chaincode Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="chaincode4ade.html">Chaincode for Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="chaincode4noah.html">Chaincode for Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="systemchaincode.html">System Chaincode Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="couchdb_tutorial.html">Using CouchDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="videos.html">Videos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ops_guide.html">Operations Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">Commands Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributions Welcome!</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">Still Have Questions?</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">Status</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>Adding an Org to a Channel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/channel_update_tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="adding-an-org-to-a-channel">
<h1>Adding an Org to a Channel<a class="headerlink" href="#adding-an-org-to-a-channel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure that you have downloaded the appropriate images and binaries
as outlined in <a class="reference internal" href="install.html"><span class="doc">Install Samples, Binaries and Docker Images</span></a> and <a class="reference internal" href="prereqs.html"><span class="doc">Prerequisites</span></a> that conform to the
version of this documentation (which can be found at the bottom of the
table of contents to the left). In particular, your version of the
<code class="docutils literal notranslate"><span class="pre">fabric-samples</span></code> folder must include the <code class="docutils literal notranslate"><span class="pre">eyfn.sh</span></code> (“Extending
Your First Network”) script and its related scripts.</p>
</div>
<p>This tutorial serves as an extension to the <a class="reference internal" href="build_network.html"><span class="doc">Building Your First Network</span></a> (BYFN) tutorial,
and will demonstrate the addition of a new organization – <code class="docutils literal notranslate"><span class="pre">Org3</span></code> – to the
application channel (<code class="docutils literal notranslate"><span class="pre">mychannel</span></code>) autogenerated by BYFN. It assumes a strong
understanding of BYFN, including the usage and functionality of the aforementioned
utilities.</p>
<p>While we will focus solely on the integration of a new organization here, the same
approach can be adopted when performing other channel configuration updates (updating
modification policies or altering batch size, for example). To learn more about the
process and possibilities of channel config updates in general, check out
<a class="reference internal" href="config_update.html"><span class="doc">Updating a Channel Configuration</span></a>). It’s also worth noting that channel configuration updates like
the one demonstrated here will usually be the responsibility of an organization admin
(rather than a chaincode or application developer).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure the automated <code class="docutils literal notranslate"><span class="pre">byfn.sh</span></code> script runs without error on
your machine before continuing. If you have exported your binaries and
the related tools (<code class="docutils literal notranslate"><span class="pre">cryptogen</span></code>, <code class="docutils literal notranslate"><span class="pre">configtxgen</span></code>, etc) into your PATH
variable, you’ll be able to modify the commands accordingly without
passing the fully qualified path.</p>
</div>
<div class="section" id="setup-the-environment">
<h2>Setup the Environment<a class="headerlink" href="#setup-the-environment" title="Permalink to this headline">¶</a></h2>
<p>We will be operating from the root of the <code class="docutils literal notranslate"><span class="pre">first-network</span></code> subdirectory within
your local clone of <code class="docutils literal notranslate"><span class="pre">fabric-samples</span></code>. Change into that directory now. You will
also want to open a few extra terminals for ease of use.</p>
<p>First, use the <code class="docutils literal notranslate"><span class="pre">byfn.sh</span></code> script to tidy up. This command will kill any active
or stale docker containers and remove previously generated artifacts. It is by no
means <strong>necessary</strong> to bring down a Fabric network in order to perform channel
configuration update tasks. However, for the sake of this tutorial, we want to operate
from a known initial state. Therefore let’s run the following command to clean up any
previous environments:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./byfn.sh down
</pre></div>
</div>
<p>Now generate the default BYFN artifacts:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./byfn.sh generate
</pre></div>
</div>
<p>And launch the network making use of the scripted execution within the CLI container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./byfn.sh up
</pre></div>
</div>
<p>Now that you have a clean version of BYFN running on your machine, you have two
different paths you can pursue. First, we offer a fully commented script that will
carry out a config transaction update to bring Org3 into the network.</p>
<p>Also, we will show a “manual” version of the same process, showing each step
and explaining what it accomplishes (since we show you how to bring down your
network before this manual process, you could also run the script and then look at
each step).</p>
</div>
<div class="section" id="bring-org3-into-the-channel-with-the-script">
<h2>Bring Org3 into the Channel with the Script<a class="headerlink" href="#bring-org3-into-the-channel-with-the-script" title="Permalink to this headline">¶</a></h2>
<p>You should be in <code class="docutils literal notranslate"><span class="pre">first-network</span></code>. To use the script, simply issue the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./eyfn.sh up
</pre></div>
</div>
<p>The output here is well worth reading. You’ll see the Org3 crypto material being
added, the config update being created and signed, and then chaincode being installed
to allow Org3 to execute ledger queries.</p>
<p>If everything goes well, you’ll get this message:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">=========</span> All GOOD, EYFN <span class="nb">test</span> execution <span class="nv">completed</span> <span class="o">===========</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">eyfn.sh</span></code> can be used with the same Node.js chaincode and database options
as <code class="docutils literal notranslate"><span class="pre">byfn.sh</span></code> by issuing the following (instead of <code class="docutils literal notranslate"><span class="pre">./byfn.sh</span> <span class="pre">up</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./byfn.sh up -c testchannel -s couchdb -l node
</pre></div>
</div>
<p>And then:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./eyfn.sh up -c testchannel -s couchdb -l node
</pre></div>
</div>
<p>For those who want to take a closer look at this process, the rest of the doc will
show you each command for making a channel update and what it does.</p>
</div>
<div class="section" id="bring-org3-into-the-channel-manually">
<h2>Bring Org3 into the Channel Manually<a class="headerlink" href="#bring-org3-into-the-channel-manually" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The manual steps outlined below assume that the <code class="docutils literal notranslate"><span class="pre">FABRIC_LOGGING_SPEC</span></code>
in the <code class="docutils literal notranslate"><span class="pre">cli</span></code> and <code class="docutils literal notranslate"><span class="pre">Org3cli</span></code> containers is set to <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code>.</p>
<p>For the <code class="docutils literal notranslate"><span class="pre">cli</span></code> container, you can set this by modifying the
<code class="docutils literal notranslate"><span class="pre">docker-compose-cli.yaml</span></code> file in the <code class="docutils literal notranslate"><span class="pre">first-network</span></code> directory.
e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cli:
  container_name: cli
  image: hyperledger/fabric-tools:$IMAGE_TAG
  tty: true
  stdin_open: true
  environment:
    - GOPATH=/opt/gopath
    - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
    #- FABRIC_LOGGING_SPEC=INFO
    - FABRIC_LOGGING_SPEC=DEBUG
</pre></div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">Org3cli</span></code> container, you can set this by modifying the
<code class="docutils literal notranslate"><span class="pre">docker-compose-org3.yaml</span></code> file in the <code class="docutils literal notranslate"><span class="pre">first-network</span></code> directory.
e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Org3cli:
  container_name: Org3cli
  image: hyperledger/fabric-tools:$IMAGE_TAG
  tty: true
  stdin_open: true
  environment:
    - GOPATH=/opt/gopath
    - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
    #- FABRIC_LOGGING_SPEC=INFO
    - FABRIC_LOGGING_SPEC=DEBUG
</pre></div>
</div>
</div>
<p>If you’ve used the <code class="docutils literal notranslate"><span class="pre">eyfn.sh</span></code> script, you’ll need to bring your network down.
This can be done by issuing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./eyfn.sh down
</pre></div>
</div>
<p>This will bring down the network, delete all the containers and undo what we’ve
done to add Org3.</p>
<p>When the network is down, bring it back up again.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./byfn.sh generate
</pre></div>
</div>
<p>Then:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./byfn.sh up
</pre></div>
</div>
<p>This will bring your network back to the same state it was in before you executed
the <code class="docutils literal notranslate"><span class="pre">eyfn.sh</span></code> script.</p>
<p>Now we’re ready to add Org3 manually. As a first step, we’ll need to generate Org3’s
crypto material.</p>
</div>
<div class="section" id="generate-the-org3-crypto-material">
<h2>Generate the Org3 Crypto Material<a class="headerlink" href="#generate-the-org3-crypto-material" title="Permalink to this headline">¶</a></h2>
<p>In another terminal, change into the <code class="docutils literal notranslate"><span class="pre">org3-artifacts</span></code> subdirectory from
<code class="docutils literal notranslate"><span class="pre">first-network</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> org3-artifacts
</pre></div>
</div>
<p>There are two <code class="docutils literal notranslate"><span class="pre">yaml</span></code> files of interest here: <code class="docutils literal notranslate"><span class="pre">org3-crypto.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">configtx.yaml</span></code>.
First, generate the crypto material for Org3:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>../../bin/cryptogen generate --config<span class="o">=</span>./org3-crypto.yaml
</pre></div>
</div>
<p>This command reads in our new crypto <code class="docutils literal notranslate"><span class="pre">yaml</span></code> file – <code class="docutils literal notranslate"><span class="pre">org3-crypto.yaml</span></code> – and
leverages <code class="docutils literal notranslate"><span class="pre">cryptogen</span></code> to generate the keys and certificates for an Org3
CA as well as two peers bound to this new Org. As with the BYFN implementation,
this crypto material is put into a newly generated <code class="docutils literal notranslate"><span class="pre">crypto-config</span></code> folder
within the present working directory (in our case, <code class="docutils literal notranslate"><span class="pre">org3-artifacts</span></code>).</p>
<p>Now use the <code class="docutils literal notranslate"><span class="pre">configtxgen</span></code> utility to print out the Org3-specific configuration
material in JSON. We will preface the command by telling the tool to look in the
current directory for the <code class="docutils literal notranslate"><span class="pre">configtx.yaml</span></code> file that it needs to ingest.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">FABRIC_CFG_PATH</span><span class="o">=</span><span class="nv">$PWD</span> <span class="o">&amp;&amp;</span> ../../bin/configtxgen -printOrg Org3MSP &gt; ../channel-artifacts/org3.json
</pre></div>
</div>
<p>The above command creates a JSON file – <code class="docutils literal notranslate"><span class="pre">org3.json</span></code> – and outputs it into the
<code class="docutils literal notranslate"><span class="pre">channel-artifacts</span></code> subdirectory at the root of <code class="docutils literal notranslate"><span class="pre">first-network</span></code>. This
file contains the policy definitions for Org3, as well as three important certificates
presented in base 64 format: the admin user certificate (which will be needed to act as
the admin of Org3 later on), a CA root cert, and a TLS root cert. In an upcoming step we
will append this JSON file to the channel configuration.</p>
<p>Our final piece of housekeeping is to port the Orderer Org’s MSP material into
the Org3 <code class="docutils literal notranslate"><span class="pre">crypto-config</span></code> directory. In particular, we are concerned with the
Orderer’s TLS root cert, which will allow for secure communication between
Org3 entities and the network’s ordering node.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ../ <span class="o">&amp;&amp;</span> cp -r crypto-config/ordererOrganizations org3-artifacts/crypto-config/
</pre></div>
</div>
<p>Now we’re ready to update the channel configuration…</p>
</div>
<div class="section" id="prepare-the-cli-environment">
<h2>Prepare the CLI Environment<a class="headerlink" href="#prepare-the-cli-environment" title="Permalink to this headline">¶</a></h2>
<p>The update process makes use of the configuration translator tool – <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code>.
This tool provides a stateless REST API independent of the SDK. Additionally it
provides a CLI, to simplify configuration tasks in Fabric networks. The tool allows
for the easy conversion between different equivalent data representations/formats
(in this case, between protobufs and JSON). Additionally, the tool can compute a
configuration update transaction based on the differences between two channel
configurations.</p>
<p>First, exec into the CLI container. Recall that this container has been
mounted with the BYFN <code class="docutils literal notranslate"><span class="pre">crypto-config</span></code> library, giving us access to the MSP material
for the two original peer organizations and the Orderer Org. The bootstrapped
identity is the Org1 admin user, meaning that any steps where we want to act as
Org2 will require the export of MSP-specific environment variables.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker <span class="nb">exec</span> -it cli bash
</pre></div>
</div>
<p>Export the <code class="docutils literal notranslate"><span class="pre">ORDERER_CA</span></code> and <code class="docutils literal notranslate"><span class="pre">CHANNEL_NAME</span></code> variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">ORDERER_CA</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem  <span class="o">&amp;&amp;</span> <span class="nb">export</span> <span class="nv">CHANNEL_NAME</span><span class="o">=</span>mychannel
</pre></div>
</div>
<p>Check to make sure the variables have been properly set:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="nv">$ORDERER_CA</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$CHANNEL_NAME</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If for any reason you need to restart the CLI container, you will also need to
re-export the two environment variables – <code class="docutils literal notranslate"><span class="pre">ORDERER_CA</span></code> and <code class="docutils literal notranslate"><span class="pre">CHANNEL_NAME</span></code>.</p>
</div>
</div>
<div class="section" id="fetch-the-configuration">
<h2>Fetch the Configuration<a class="headerlink" href="#fetch-the-configuration" title="Permalink to this headline">¶</a></h2>
<p>Now we have a CLI container with our two key environment variables – <code class="docutils literal notranslate"><span class="pre">ORDERER_CA</span></code>
and <code class="docutils literal notranslate"><span class="pre">CHANNEL_NAME</span></code> exported.  Let’s go fetch the most recent config block for the
channel – <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>.</p>
<p>The reason why we have to pull the latest version of the config is because channel
config elements are versioned. Versioning is important for several reasons. It prevents
config changes from being repeated or replayed (for instance, reverting to a channel config
with old CRLs would represent a security risk). Also it helps ensure concurrency (if you
want to remove an Org from your channel, for example, after a new Org has been added,
versioning will help prevent you from removing both Orgs, instead of just the Org you want
to remove).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c <span class="nv">$CHANNEL_NAME</span> --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>This command saves the binary protobuf channel configuration block to
<code class="docutils literal notranslate"><span class="pre">config_block.pb</span></code>. Note that the choice of name and file extension is arbitrary.
However, following a convention which identifies both the type of object being
represented and its encoding (protobuf or JSON) is recommended.</p>
<p>When you issued the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command, there was a decent amount of
output in the terminal. The last line in the logs is of interest:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2017</span>-11-07 <span class="m">17</span>:17:57.383 UTC <span class="o">[</span>channelCmd<span class="o">]</span> readBlock -&gt; DEBU <span class="m">011</span> Received block: <span class="m">2</span>
</pre></div>
</div>
<p>This is telling us that the most recent configuration block for <code class="docutils literal notranslate"><span class="pre">mychannel</span></code> is
actually block 2, <strong>NOT</strong> the genesis block. By default, the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span> <span class="pre">config</span></code>
command returns the most <strong>recent</strong> configuration block for the targeted channel, which
in this case is the third block. This is because the BYFN script defined anchor
peers for our two organizations – <code class="docutils literal notranslate"><span class="pre">Org1</span></code> and <code class="docutils literal notranslate"><span class="pre">Org2</span></code> – in two separate channel update
transactions.</p>
<p>As a result, we have the following configuration sequence:</p>
<blockquote>
<div><ul class="simple">
<li><p>block 0: genesis block</p></li>
<li><p>block 1: Org1 anchor peer update</p></li>
<li><p>block 2: Org2 anchor peer update</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="convert-the-configuration-to-json-and-trim-it-down">
<h2>Convert the Configuration to JSON and Trim It Down<a class="headerlink" href="#convert-the-configuration-to-json-and-trim-it-down" title="Permalink to this headline">¶</a></h2>
<p>Now we will make use of the <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> tool to decode this channel
configuration block into JSON format (which can be read and modified by humans).
We also must strip away all of the headers, metadata, creator signatures, and
so on that are irrelevant to the change we want to make. We accomplish this by
means of the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_block.pb --type common.Block <span class="p">|</span> jq .data.data<span class="o">[</span><span class="m">0</span><span class="o">]</span>.payload.data.config &gt; config.json
</pre></div>
</div>
<p>This leaves us with a trimmed down JSON object – <code class="docutils literal notranslate"><span class="pre">config.json</span></code>, located in
the <code class="docutils literal notranslate"><span class="pre">fabric-samples</span></code> folder inside <code class="docutils literal notranslate"><span class="pre">first-network</span></code> – which
will serve as the baseline for our config update.</p>
<p>Take a moment to open this file inside your text editor of choice (or in your
browser). Even after you’re done with this tutorial, it will be worth studying it
as it reveals the underlying configuration structure and the other kind of channel
updates that can be made. We discuss them in more detail in <a class="reference internal" href="config_update.html"><span class="doc">Updating a Channel Configuration</span></a>.</p>
</div>
<div class="section" id="add-the-org3-crypto-material">
<h2>Add the Org3 Crypto Material<a class="headerlink" href="#add-the-org3-crypto-material" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The steps you’ve taken up to this point will be nearly identical no matter
what kind of config update you’re trying to make. We’ve chosen to add an
org with this tutorial because it’s one of the most complex channel
configuration updates you can attempt.</p>
</div>
<p>We’ll use the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool once more to append the Org3 configuration definition
– <code class="docutils literal notranslate"><span class="pre">org3.json</span></code> – to the channel’s application groups field, and name the output
– <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jq -s <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;groups&quot;:{&quot;Application&quot;:{&quot;groups&quot;: {&quot;Org3MSP&quot;:.[1]}}}}}&#39;</span> config.json ./channel-artifacts/org3.json &gt; modified_config.json
</pre></div>
</div>
<p>Now, within the CLI container we have two JSON files of interest – <code class="docutils literal notranslate"><span class="pre">config.json</span></code>
and <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code>. The initial file contains only Org1 and Org2 material,
whereas “modified” file contains all three Orgs. At this point it’s simply
a matter of re-encoding these two JSON files and calculating the delta.</p>
<p>First, translate <code class="docutils literal notranslate"><span class="pre">config.json</span></code> back into a protobuf called <code class="docutils literal notranslate"><span class="pre">config.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb
</pre></div>
</div>
<p>Next, encode <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code> to <code class="docutils literal notranslate"><span class="pre">modified_config.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb
</pre></div>
</div>
<p>Now use <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> to calculate the delta between these two config
protobufs. This command will output a new protobuf binary named <code class="docutils literal notranslate"><span class="pre">org3_update.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator compute_update --channel_id <span class="nv">$CHANNEL_NAME</span> --original config.pb --updated modified_config.pb --output org3_update.pb
</pre></div>
</div>
<p>This new proto – <code class="docutils literal notranslate"><span class="pre">org3_update.pb</span></code> – contains the Org3 definitions and high
level pointers to the Org1 and Org2 material. We are able to forgo the extensive
MSP material and modification policy information for Org1 and Org2 because this
data is already present within the channel’s genesis block. As such, we only need
the delta between the two configurations.</p>
<p>Before submitting the channel update, we need to perform a few final steps. First,
let’s decode this object into editable JSON format and call it <code class="docutils literal notranslate"><span class="pre">org3_update.json</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input org3_update.pb --type common.ConfigUpdate <span class="p">|</span> jq . &gt; org3_update.json
</pre></div>
</div>
<p>Now, we have a decoded update file – <code class="docutils literal notranslate"><span class="pre">org3_update.json</span></code> – that we need to wrap
in an envelope message. This step will give us back the header field that we stripped away
earlier. We’ll name this file <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.json</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;mychannel&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;</span><span class="k">$(</span>cat org3_update.json<span class="k">)</span><span class="s1">&#39;}}}&#39;</span> <span class="p">|</span> jq . &gt; org3_update_in_envelope.json
</pre></div>
</div>
<p>Using our properly formed JSON – <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.json</span></code> – we will
leverage the <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> tool one last time and convert it into the
fully fledged protobuf format that Fabric requires. We’ll name our final update
object <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input org3_update_in_envelope.json --type common.Envelope --output org3_update_in_envelope.pb
</pre></div>
</div>
</div>
<div class="section" id="sign-and-submit-the-config-update">
<h2>Sign and Submit the Config Update<a class="headerlink" href="#sign-and-submit-the-config-update" title="Permalink to this headline">¶</a></h2>
<p>Almost done!</p>
<p>We now have a protobuf binary – <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.pb</span></code> – within
our CLI container. However, we need signatures from the requisite Admin users
before the config can be written to the ledger. The modification policy (mod_policy)
for our channel Application group is set to the default of “MAJORITY”, which means that
we need a majority of existing org admins to sign it. Because we have only two orgs –
Org1 and Org2 – and the majority of two is two, we need both of them to sign. Without
both signatures, the ordering service will reject the transaction for failing to
fulfill the policy.</p>
<p>First, let’s sign this update proto as the Org1 Admin. Remember that the CLI container
is bootstrapped with the Org1 MSP material, so we simply need to issue the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">signconfigtx</span></code> command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel signconfigtx -f org3_update_in_envelope.pb
</pre></div>
</div>
<p>The final step is to switch the CLI container’s identity to reflect the Org2 Admin
user. We do this by exporting four environment variables specific to the Org2 MSP.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Switching between organizations to sign a config transaction (or to do anything
else) is not reflective of a real-world Fabric operation. A single container
would never be mounted with an entire network’s crypto material. Rather, the
config update would need to be securely passed out-of-band to an Org2
Admin for inspection and approval.</p>
</div>
<p>Export the Org2 environment variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org2MSP&quot;</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt

<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp

<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org2.example.com:9051
</pre></div>
</div>
<p>Lastly, we will issue the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">update</span></code> command. The Org2 Admin signature
will be attached to this call so there is no need to manually sign the protobuf a
second time:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The upcoming update call to the ordering service will undergo a series
of systematic signature and policy checks. As such you may find it
useful to stream and inspect the ordering node’s logs. From another shell,
issue a <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">-f</span> <span class="pre">orderer.example.com</span></code> command to display them.</p>
</div>
<p>Send the update call:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel update -f org3_update_in_envelope.pb -c <span class="nv">$CHANNEL_NAME</span> -o orderer.example.com:7050 --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>You should see a message digest indication similar to the following if your
update has been submitted successfully:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2018</span>-02-24 <span class="m">18</span>:56:33.499 UTC <span class="o">[</span>msp/identity<span class="o">]</span> Sign -&gt; DEBU 00f Sign: digest: 3207B24E40DE2FAB87A2E42BC004FEAA1E6FDCA42977CB78C64F05A88E556ABA
</pre></div>
</div>
<p>You will also see the submission of our configuration transaction:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2018</span>-02-24 <span class="m">18</span>:56:33.499 UTC <span class="o">[</span>channelCmd<span class="o">]</span> update -&gt; INFO <span class="m">010</span> Successfully submitted channel update
</pre></div>
</div>
<p>The successful channel update call returns a new block – block 5 – to all of the
peers on the channel. If you remember, blocks 0-2 are the initial channel
configurations while blocks 3 and 4 are the instantiation and invocation of
the <code class="docutils literal notranslate"><span class="pre">mycc</span></code> chaincode. As such, block 5 serves as the most recent channel
configuration with Org3 now defined on the channel.</p>
<p>Inspect the logs for <code class="docutils literal notranslate"><span class="pre">peer0.org1.example.com</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker logs -f peer0.org1.example.com
</pre></div>
</div>
<p>Follow the demonstrated process to fetch and decode the new config block if you wish to inspect
its contents.</p>
</div>
<div class="section" id="configuring-leader-election">
<h2>Configuring Leader Election<a class="headerlink" href="#configuring-leader-election" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section is included as a general reference for understanding
the leader election settings when adding organizations to a network
after the initial channel configuration has completed. This sample
defaults to dynamic leader election, which is set for all peers in the
network in <cite>peer-base.yaml</cite>.</p>
</div>
<p>Newly joining peers are bootstrapped with the genesis block, which does not
contain information about the organization that is being added in the channel
configuration update. Therefore new peers are not able to utilize gossip as
they cannot verify blocks forwarded by other peers from their own organization
until they get the configuration transaction which added the organization to the
channel. Newly added peers must therefore have one of the following
configurations so that they receive blocks from the ordering service:</p>
<p>1. To utilize static leader mode, configure the peer to be an organization
leader:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">false</span>
<span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This configuration must be the same for all new peers added to the
channel.</p>
</div>
<p>2. To utilize dynamic leader election, configure the peer to use leader
election:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">true</span>
<span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because peers of the newly added organization won’t be able to form
membership view, this option will be similar to the static
configuration, as each peer will start proclaiming itself to be a
leader. However, once they get updated with the configuration
transaction that adds the organization to the channel, there will be
only one active leader for the organization. Therefore, it is
recommended to leverage this option if you eventually want the
organization’s peers to utilize leader election.</p>
</div>
</div>
<div class="section" id="join-org3-to-the-channel">
<h2>Join Org3 to the Channel<a class="headerlink" href="#join-org3-to-the-channel" title="Permalink to this headline">¶</a></h2>
<p>At this point, the channel configuration has been updated to include our new
organization – <code class="docutils literal notranslate"><span class="pre">Org3</span></code> – meaning that peers attached to it can now join <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>.</p>
<p>First, let’s launch the containers for the Org3 peers and an Org3-specific CLI.</p>
<p>Open a new terminal and from <code class="docutils literal notranslate"><span class="pre">first-network</span></code> kick off the Org3 docker compose:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker-compose -f docker-compose-org3.yaml up -d
</pre></div>
</div>
<p>This new compose file has been configured to bridge across our initial network,
so the two peers and the CLI container will be able to resolve with the existing
peers and ordering node. With the three new containers now running, exec into
the Org3-specific CLI container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker <span class="nb">exec</span> -it Org3cli bash
</pre></div>
</div>
<p>Just as we did with the initial CLI container, export the two key environment
variables: <code class="docutils literal notranslate"><span class="pre">ORDERER_CA</span></code> and <code class="docutils literal notranslate"><span class="pre">CHANNEL_NAME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">ORDERER_CA</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem <span class="o">&amp;&amp;</span> <span class="nb">export</span> <span class="nv">CHANNEL_NAME</span><span class="o">=</span>mychannel
</pre></div>
</div>
<p>Check to make sure the variables have been properly set:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="nv">$ORDERER_CA</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$CHANNEL_NAME</span>
</pre></div>
</div>
<p>Now let’s send a call to the ordering service asking for the genesis block of
<code class="docutils literal notranslate"><span class="pre">mychannel</span></code>. The ordering service is able to verify the Org3 signature
attached to this call as a result of our successful channel update. If Org3
has not been successfully appended to the channel config, the ordering
service should reject this request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Again, you may find it useful to stream the ordering node’s logs
to reveal the sign/verify logic and policy checks.</p>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command to retrieve this block:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch <span class="m">0</span> mychannel.block -o orderer.example.com:7050 -c <span class="nv">$CHANNEL_NAME</span> --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>Notice, that we are passing a <code class="docutils literal notranslate"><span class="pre">0</span></code> to indicate that we want the first block on
the channel’s ledger (i.e. the genesis block). If we simply passed the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span> <span class="pre">config</span></code> command, then we would have received block 5 – the
updated config with Org3 defined. However, we can’t begin our ledger with a
downstream block – we must start with block 0.</p>
<p>Issue the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">join</span></code> command and pass in the genesis block – <code class="docutils literal notranslate"><span class="pre">mychannel.block</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel join -b mychannel.block
</pre></div>
</div>
<p>If you want to join the second peer for Org3, export the <code class="docutils literal notranslate"><span class="pre">TLS</span></code> and <code class="docutils literal notranslate"><span class="pre">ADDRESS</span></code> variables
and reissue the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">join</span> <span class="pre">command</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer1.org3.example.com/tls/ca.crt <span class="o">&amp;&amp;</span> <span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer1.org3.example.com:12051

peer channel join -b mychannel.block
</pre></div>
</div>
</div>
<div class="section" id="install-define-and-invoke-chaincode">
<span id="upgrade-and-invoke"></span><h2>Install, define, and invoke chaincode<a class="headerlink" href="#install-define-and-invoke-chaincode" title="Permalink to this headline">¶</a></h2>
<p>Once you have joined the channel, you can package and install a chaincode on a
peer of Org3. You then need to approve the chaincode definition as org3.
Because the chaincode definition has already been committed to the channel
you have joined, you can start using the chaincode after you approve the
definition.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These instructions use the Fabric chaincode lifecycle introduced in
the v2.0 Alpha release. If you would like to use the previous
lifecycle to install and instantiate a chaincode, visit the v1.4
version of the <a class="reference external" href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/channel_update_tutorial.html">Adding an org to a channel tutorial</a>.</p>
</div>
<p>The first step is to package the chaincode from the Org3 CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer lifecycle chaincode package mycc.tar.gz --path github.com/hyperledger/fabric-samples/chaincode/abstore/go/ --lang golang --label mycc_1
</pre></div>
</div>
<p>This command will create a chaincode package named <code class="docutils literal notranslate"><span class="pre">mycc.tar.gz</span></code>, which we can
use to install the chaincode on our peer. In this command, you need to provide a
chaincode package label as a description of the chaincode. Modify the command
accordingly if the channel is running a chaincode written in Java or Node.js.
Issue the following command to install the package on peer0 of Org3:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># this command installs a chaincode package on your peer</span>
peer lifecycle chaincode install mycc.tar.gz
</pre></div>
</div>
<p>You can also modify the environment variables and reissue the command if you
want to install the chaincode on the second peer of Org3. Note that a second
installation is not mandated, as you only need to install chaincode on peers
that are going to serve as endorsers or otherwise interface with the ledger
(i.e. query only). Peers will still run the validation logic and serve as
committers without a running chaincode container.</p>
<p>The next step is to approve the chaincode definition of <code class="docutils literal notranslate"><span class="pre">mycc</span></code> as Org3. Org3
needs to approve the same definition that Org1 and Org2 approved and committed
to the channel. The chaincode definition also needs to include the chaincode
package identifier. You can find the package identifier by querying your peer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># this returns the details of the packages installed on your peers</span>
peer lifecycle chaincode queryinstalled
</pre></div>
</div>
<p>You should see output similar to the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Get installed chaincodes on peer:
Package ID: mycc_1:3a8c52d70c36313cfebbaf09d8616e7a6318ababa01c7cbe40603c373bcfe173, Label: mycc_1
</pre></div>
</div>
<p>We are going to need the package ID in a future command, so lets go ahead and
save it as an environment variable. Paste the package ID returned by the
<cite>peer lifecycle chaincode queryinstalled</cite> into the command below. The package ID
may not be the same for all users, so you need to complete this step using the
package ID returned from your console.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save the package ID as an environment variable.</span>

<span class="nv">CC_PACKAGE_ID</span><span class="o">=</span>mycc_1:3a8c52d70c36313cfebbaf09d8616e7a6318ababa01c7cbe40603c373bcfe173
</pre></div>
</div>
<p>Use the following command to approve a definition of the  <code class="docutils literal notranslate"><span class="pre">mycc</span></code> chaincode
for Org3:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># this approves a chaincode definition for your org</span>
<span class="c1"># use the --package-id flag to provide the package identifier</span>
<span class="c1"># use the --init-required flag to request the ``Init`` function be invoked to initialize the chaincode</span>
peer lifecycle chaincode approveformyorg --channelID <span class="nv">$CHANNEL_NAME</span> --name mycc --version <span class="m">1</span>.0 --init-required --package-id <span class="nv">$CC_PACKAGE_ID</span> --sequence <span class="m">1</span> --tls <span class="nb">true</span> --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --waitForEvent
</pre></div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">lifecycle</span> <span class="pre">chaincode</span> <span class="pre">querycommitted</span></code> command to check if
the chaincode definition you have approved has already been committed to the
channel.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the --name flag to select the chaincode whose definition you want to query</span>
peer lifecycle chaincode querycommitted --channelID <span class="nv">$CHANNEL_NAME</span> --name mycc --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
</pre></div>
</div>
<p>A successful command will return information about the committed definition:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Committed chaincode definition <span class="k">for</span> chaincode <span class="s1">&#39;mycc&#39;</span> on channel <span class="s1">&#39;mychannel&#39;</span>:
Version: <span class="m">1</span>, Sequence: <span class="m">1</span>, Endorsement Plugin: escc, Validation Plugin: vscc
</pre></div>
</div>
<p>Since the chaincode definition has already been committed, you are ready to use
the <code class="docutils literal notranslate"><span class="pre">mycc</span></code> chaincode after you approve the definition. The chaincode definition
uses the default endorsement policy, which requires a majority of organizations
on the channel endorse a transaction. This implies that if an organization is
added to or removed from the channel, the endorsement policy is updated
automatically. We previously needed endorsements from Org1 and Org2 (2 out of 2).
Now we need endorsements from two organizations out of Org1, Org2, and Org3 (2
out of 3).</p>
<p>Query the chaincode to ensure that it has started. Note that you may need to
wait for the chaincode container to start.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode query -C <span class="nv">$CHANNEL_NAME</span> -n mycc -c <span class="s1">&#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39;</span>
</pre></div>
</div>
<p>We should see a response of <code class="docutils literal notranslate"><span class="pre">Query</span> <span class="pre">Result:</span> <span class="pre">90</span></code>.</p>
<p>Now issue an invocation to move <code class="docutils literal notranslate"><span class="pre">10</span></code> from <code class="docutils literal notranslate"><span class="pre">a</span></code> to <code class="docutils literal notranslate"><span class="pre">b</span></code>. In the command
below, we target a peer in Org1 and Org3 to collect a sufficient number of
endorsements.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode invoke -o orderer.example.com:7050  --tls <span class="nv">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="nv">$ORDERER_CA</span> -C <span class="nv">$CHANNEL_NAME</span> -n mycc -c <span class="s1">&#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39;</span> --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses peer0.org3.example.com:11051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
</pre></div>
</div>
<p>Query one final time:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode query -C <span class="nv">$CHANNEL_NAME</span> -n mycc -c <span class="s1">&#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39;</span>
</pre></div>
</div>
<p>We should see a response of <code class="docutils literal notranslate"><span class="pre">Query</span> <span class="pre">Result:</span> <span class="pre">80</span></code>, accurately reflecting the
update of this chaincode’s world state.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>The channel configuration update process is indeed quite involved, but there is a
logical method to the various steps. The endgame is to form a delta transaction object
represented in protobuf binary format and then acquire the requisite number of admin
signatures such that the channel configuration update transaction fulfills the channel’s
modification policy.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> and <code class="docutils literal notranslate"><span class="pre">jq</span></code> tools, along with the ever-growing <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span></code>
commands, provide us with the functionality to accomplish this task.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="upgrading_your_network_tutorial.html" class="btn btn-neutral float-right" title="Upgrading Your Network Components" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="build_network.html" class="btn btn-neutral" title="Building Your First Network" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2019.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>